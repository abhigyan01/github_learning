pipeline {
    agent any    

    environment {
         name= "Abhigyan Bhattacharjee"
        topics = 'DevOps'
        DOCKER_REGISTRY = "abhigyan01"
        IMAGE_NAME = "jenkins"
        IMAGE_TAG = "latest"
        DOCKERFILE_PATH = "Dockerfile" // Path to your Dockerfile
       REGISTRY = "abhigyan01/jenkins"
       registryCredential = 'dockerhub_id'
        dockerImage = ''
       //DOCKER_ACCESS_TOKEN = credentials('docker-credentials-id')//docker-hub-credentials
       // DOCKER_ACCESS_TOKEN = credentials('docker-hub-credentials')
    }
   // parameters {
     //   string(name:"person", defaultValue:"nothing", description:"")
    //}
    stages{
        stage('Build Docker Image') {
            steps {
                script {
                    // Build the Docker image
                    //docker.build("$DOCKER_REGISTRY/$IMAGE_NAME:$IMAGE_TAG", "-f $DOCKERFILE_PATH .")
                    //sh "docker build -t $DOCKER_REGISTRY/$IMAGE_NAME:$IMAGE_TAG -f $DOCKERFILE_PATH ."
                    dockerImage = docker.build REGISTRY + ":$BUILD_NUMBER"

                }
            }
        }
        stage('Push Docker Image') {
            steps {
               script {
                    // Login to Docker registry using access token
                    // withCredentials([usernamePassword(credentialsId: 'myregistry-login', passwordVariable: 'DOCKER_REGISTRY_PWD', usernameVariable: 'DOCKER_REGISTRY_USER')]) 
                   // withDockerRegistry([credentialsId: 'docker-credentials-id']) {
                   // sh "docker login -u _token -p $DOCKER_ACCESS_TOKEN $DOCKER_REGISTRY"
                   // }
                   // Push Docker image to registry
                    //sh "docker push $DOCKER_REGISTRY/$IMAGE_NAME:$IMAGE_TAG"
                    docker.withRegistry( '', registryCredential ) {
                    dockerImage.push()
                    }
                } 
            }  
        }

        stage("kubernetes deployment"){
            steps{
                sh 'kubectl apply -f deployment.yml'
            }
        
    }
        stage('Cleaning up') {
            steps{
                sh "docker rmi $REGISTRY:$BUILD_NUMBER"
            }
        }
    } 
}